<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="js/Casilla.js"></script>
        <script src="js/Loko.js"></script>
        <title></title>
    </head>
    <body>    
        <canvas id="juego" style="position:fixed;top:0;left:0;background-color:gray;"></canvas>
        <script type="text/javascript">
            function cargarImagen(src) {
                return new Promise(function (success) {

                    var image = new Image();

                    image.src = src;

                    image.onload = function () {
                        success(this);
                    };

                });
            }

            juego.width = innerWidth;
            juego.height = innerHeight;

            lienzo = juego;
            ctx = juego.getContext('2d');

            var estructura = {
                casillas: [],

                // De cuántas casillas por cuántas es la sala
                dimensiones_casillas: {
                    x: 10,
                    y: 12,
                    w: 60,
                    h: 30
                }
            };

            /*
             *
             *	Crear los objetos de las casillas
             *
             **/
            for (var x = 0; x < estructura.dimensiones_casillas.x; x++) {
                if (estructura.casillas[x] == undefined) {
                    estructura.casillas[x] = [];
                }
                for (var y = 0; y < estructura.dimensiones_casillas.y; y++) {
                    let casilla = new Casilla(x, y, estructura.dimensiones_casillas.w, estructura.dimensiones_casillas.h);
                    cargarImagen(casilla.src).then(function (img) {
                        casilla.img = img;
                    });

                    casilla.pos_x = ((estructura.dimensiones_casillas.x - 1) * (casilla.width / 2)) + y * (casilla.width / 2) - x * (casilla.width / 2 - 1);
                    casilla.pos_y = y * (casilla.height / 2) + x * (casilla.height / 2) + 1;


                    estructura.casillas[x][y] = casilla;
                }
            }
            console.log(estructura.casillas);
            /*
             *
             *	Posición de la camara
             *
             */
            var CAMARA_vista = {
                x: 0,
                y: 0
            };

            /*
             *
             *	Selector de casilla
             *
             */
            var selector = {
                image_src: 'selector.png',
                img: null,
                coords_x: 0,
                coords_y: 0,
                casilla: null
            };

            cargarImagen(selector.image_src).then(function (img) {
                selector.img = img;
            });

            juego.addEventListener('mousemove', function (event) {

                /*
                 Calculamos qué casilla está apuntando el usuario
                 */
                let mouse_x = event.clientX - CAMARA_vista.x;
                let mouse_y = event.clientY - CAMARA_vista.y;

                let tile_height = 30;
                let tile_width = 60;

                hoverTileX = Math.floor((mouse_y / tile_height) + (mouse_x / tile_width)) - 5;
                hoverTileY = Math.floor((-mouse_x / tile_width) + (mouse_y / tile_height))+5;

                var coordsFinal = {
                    y: hoverTileX, // + (estructura.dimensiones_casillas.w /2),
                    x: hoverTileY// + (estructura.dimensiones_casillas.h / 2)
                };

                selector.coords_x = coordsFinal.x;
                selector.coords_y = coordsFinal.y;
                selector.x = mouse_x;
                selector.y = mouse_y;

                // La casilla
                selector.casilla = estructura.casillas[selector.coords_x] ? estructura.casillas[selector.coords_x][selector.coords_y] : null;
            });


            function VisualizarJuego() {
                ctx.clearRect(0, 0, juego.width, juego.height);
                //Suelo
                for (var x = 0; x < estructura.casillas.length; x++) {
                    for (var y = 0; y < estructura.casillas[x].length; y++) {
                        var casilla = estructura.casillas[x][y];
                        ctx.drawImage(casilla.img, Math.floor(CAMARA_vista.x + casilla.pos_x), Math.floor(CAMARA_vista.y + casilla.pos_y));
                    }
                }
                //Selector
                if (selector.img && selector.casilla) {
                    ctx.drawImage(selector.img, Math.floor(CAMARA_vista.x + selector.casilla.pos_x), Math.floor(CAMARA_vista.y + selector.casilla.pos_y));
                }

                ctx.font = "30px Arial";
                ctx.fillText("coords_x: " + selector.coords_x + " coords_y: " + selector.coords_y, 600, 50);
                ctx.fillText("x: " + selector.x + " y: " + selector.y, 600, 80);
                window.requestAnimationFrame(VisualizarJuego);
            }

            window.addEventListener("load", function () {
                VisualizarJuego();
            });
        </script>

    </body>
</html>
